AWSTemplateFormatVersion: '2010-09-09'
Transform:
- 'AWS::LanguageExtensions'
Description: |
  AWS Organization Backup Policies - Multi-Environment Support
  Adaptado para usar tag key data-type-bkp con valores especificos por tipo de dato
  Basado en estrategia consolidada de retenciones por frecuencia

Parameters:
  # ========================================
  # ORGANIZATIONAL UNITS
  # ========================================
  pOrgBackupTargetOUsProduction:
    Description: Comma separated list of Production OUs to attach backup policies
    Type: AWS::SSM::Parameter::Value<CommaDelimitedList>
    Default: "/backup/target/organizational-units"
  
  pRegions:
    Description: Target regions for backup plans as a comma delimited list
    Type: AWS::SSM::Parameter::Value<CommaDelimitedList>
    Default: "/backup/target/regions"
  
  # ========================================
  # VAULT CONFIGURATION
  # ========================================
  pCentralBackupVaultArn:
    Description: ARN of centralized AWS Backup Vault for secondary storage (copy actions)
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/backup/central-vault-arn"
  
  pMemberAccountBackupVault:
    Description: Name of the member account Backup vault (local vault)
    AllowedPattern: ^[a-zA-Z0-9\-\_\.]{1,50}$
    ConstraintDescription: Vault name is case sensitive
    Type: String
    Default: AWSBackupSolutionVault
  
  pCrossAccountBackupRole:
    Description: IAM role name for cross-account backup operations
    Type: String
    Default: AWSBackupSolutionRole
  
  # ========================================
  # TAG CONFIGURATION (NUEVO)
  # ========================================
  pBackupTagKey:
    Type: String
    Description: Tag key to identify resources for backup (CHANGED from 'backup' to 'data-type-bkp')
    Default: 'data-type-bkp'
  
  # ========================================
  # BACKUP SCHEDULES
  # ========================================
  pDailyBackupSchedule:
    Description: CRON schedule for daily backups (Sun-Fri at 02:30 UTC)
    Type: String
    Default: cron(30 2 ? * SUN-FRI *)
  
  pWeeklyBackupSchedule:
    Description: CRON schedule for weekly backups (Saturday at 02:30 UTC)
    Type: String
    Default: cron(30 2 ? * SAT *)
  
  pMonthlyBackupSchedule:
    Description: CRON schedule for monthly backups (1st day of month at 02:30 UTC)
    Type: String
    Default: cron(30 2 1 * ? *)
  
  # ========================================
  # TAGGING
  # ========================================
  pTagKey:
    Type: String
    Description: Tag key for resource tagging
    Default: 'project'
  
  pTagValue:
    Type: String
    Description: Tag value for resource tagging
    Default: 'aws-backup'
  
  CommitId:
    Description: The commit id for the change
    Type: String
  
  BusinessUnit:
    Description: Business Unit Name
    Type: String
    MinLength: '1'
    MaxLength: '255'
    AllowedValues:
    - Marketing
    - Engineering
    - R&D
    ConstraintDescription: Must be a valid business unit
    Default: Engineering
  
  CostCenter:
    Description: Cost Center for AWS Services
    Type: String
    MinLength: '1'
    MaxLength: '255'
    Default: '00000'
  
  Environment:
    Description: Environment
    Type: String
    AllowedValues:
    - Development
    - QA
    - Production
    ConstraintDescription: Must be a valid environment.
    Default: Production
  
  ApplicationOwner:
    Description: Email address of application owner
    Type: String
    Default: backup-admin@example.com
  
  Application:
    Description: Application Name
    Type: String
    Default: AWS Backup Solution

Resources:

  # ========================================
  # POLICY 1: DAILY BACKUP - 7 DAYS
  # Tag Values: app-object, apps-logs
  # ========================================
  rOrgBackupPolicyDaily7d:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-daily-7d-production
      Description: Daily backup (Sun-Fri) for operational data with 7 days retention
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanDaily7d:
              rules:
                OrgDailyBackupRule7d:
                  schedule_expression:
                    "@@assign": !Ref pDailyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '600'  # 10 hours (240-600 min range)
                  lifecycle:
                    delete_after_days:
                      "@@assign": '7'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "7"
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgDaily7dSelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": !Ref pBackupTagKey
                    tag_value:
                      "@@assign":
                      - "app-object"
                      - "apps-logs"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

  # ========================================
  # POLICY 2: WEEKLY BACKUP - 30 DAYS
  # Tag Values: code-data, backup-weekly, financial-data, 
  #             regulated-logs, audit-logs, backup-w-m, core-data
  # ========================================
  rOrgBackupPolicyWeekly30d:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-weekly-30d-production
      Description: Weekly backup (Saturday) for operational data with 30 days retention
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanWeekly30d:
              rules:
                OrgWeeklyBackupRule30d:
                  schedule_expression:
                    "@@assign": !Ref pWeeklyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '1440'  # 24 hours (360-1440 min range)
                  lifecycle:
                    delete_after_days:
                      "@@assign": '30'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "30"
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgWeekly30dSelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": !Ref pBackupTagKey
                    tag_value:
                      "@@assign":
                      - "code-data"
                      - "backup-weekly"
                      - "financial-data"
                      - "regulated-logs"
                      - "audit-logs"
                      - "backup-w-m"
                      - "core-data"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

  # ========================================
  # POLICY 3: MONTHLY BACKUP - 90 DAYS
  # Tag Values: audit-logs, core-data, backup-w-m, backup-monthly-3
  # ========================================
  rOrgBackupPolicyMonthly90d:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-monthly-90d-production
      Description: Monthly backup (4th Saturday) for audit data with 90 days retention
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanMonthly90d:
              rules:
                OrgMonthlyBackupRule90d:
                  schedule_expression:
                    "@@assign": !Ref pMonthlyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '1440'
                  lifecycle:
                    delete_after_days:
                      "@@assign": '90'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "90"
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgMonthly90dSelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": !Ref pBackupTagKey
                    tag_value:
                      "@@assign":
                      - "audit-logs"
                      - "core-data"
                      - "backup-w-m"
                      - "backup-monthly-3"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

  # ========================================
  # POLICY 4: MONTHLY BACKUP - 180 DAYS (with Cold Storage)
  # Tag Values: regulated-logs, backup-monthly-6
  # TEMPORAL: Comentado para investigar error de validacion
  # Error: "policy document does not meet requirements"
  # Ver: historico/ERROR_ORG_POLICY_MONTHLY180D_28NOV2025.md
  # ========================================
  # rOrgBackupPolicyMonthly180d:
  #   Type: AWS::Organizations::Policy
  #   Properties:
  #     Name: org-backup-monthly-180d-production
  #     Description: Monthly backup (4th Saturday) for regulated logs with 180 days retention and cold storage
  #     Type: BACKUP_POLICY
  #     TargetIds: !Ref pOrgBackupTargetOUsProduction
  #     Content:
  #       Fn::ToJsonString:
  #         plans:
  #           OrgBackupPlanMonthly180d:
  #             rules:
  #               OrgMonthlyBackupRule180d:
  #                 schedule_expression:
  #                   "@@assign": !Ref pMonthlyBackupSchedule
  #                 start_backup_window_minutes:
  #                   "@@assign": '60'
  #                 complete_backup_window_minutes:
  #                   "@@assign": '1440'
  #                 lifecycle:
  #                   move_to_cold_storage_after_days:
  #                     "@@assign": '90'
  #                   delete_after_days:
  #                     "@@assign": '180'
  #                 target_backup_vault_name:
  #                   "@@assign": !Ref pMemberAccountBackupVault
  #                 recovery_point_tags:
  #                   project:
  #                     tag_key:
  #                       "@@assign": !Ref pTagKey
  #                     tag_value:
  #                       "@@assign": !Ref pTagValue
  #                   retention:
  #                     tag_key:
  #                       "@@assign": "retention-days"
  #                     tag_value:
  #                       "@@assign": "180"
  #             backup_plan_tags:
  #               project:
  #                 tag_key:
  #                   "@@assign": !Ref pTagKey
  #                 tag_value:
  #                   "@@assign": !Ref pTagValue
  #             regions:
  #               "@@append": !Ref pRegions
  #             selections:
  #               tags:
  #                 OrgMonthly180dSelection:
  #                   iam_role_arn:
  #                     "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
  #                   tag_key:
  #                     "@@assign": !Ref pBackupTagKey
  #                   tag_value:
  #                     "@@assign":
  #                     - "regulated-logs"
  #                     - "backup-monthly-6"
  #     Tags:
  #     - Key: Application
  #       Value: !Ref Application
  #     - Key: CommitId
  #       Value: !Ref CommitId
  #     - Key: BusinessUnit
  #       Value: !Ref BusinessUnit
  #     - Key: CostCenter
  #       Value: !Ref CostCenter
  #     - Key: Environment
  #       Value: !Ref Environment
  #     - Key: ApplicationOwner
  #       Value: !Ref ApplicationOwner


  # ========================================
  # POLICY 5: CRITICAL DATA - 10 YEARS (with Copy Actions)
  # Tag Values: transactions-regulated, client-data, financial-data
  # This is the ONLY policy with copy actions to central vault
  # ========================================
  
  # Rule 5a: Daily backup for critical data (7 days local)
  rOrgBackupPolicyCriticalDaily:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-critical-daily-7d-production
      Description: Daily backup for critical data with 7 days local retention
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanCriticalDaily:
              rules:
                OrgCriticalDailyBackupRule:
                  schedule_expression:
                    "@@assign": !Ref pDailyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '600'
                  lifecycle:
                    delete_after_days:
                      "@@assign": '7'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "7"
                    data-criticality:
                      tag_key:
                        "@@assign": "data-criticality"
                      tag_value:
                        "@@assign": "critical"
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgCriticalDailySelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": !Ref pBackupTagKey
                    tag_value:
                      "@@assign":
                      - "transactions-regulated"
                      - "client-data"
                      - "financial-data"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

  # Rule 5b: Monthly backup for critical data (10 years with copy to central)
  rOrgBackupPolicyCriticalMonthly10y:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-critical-monthly-10y-production
      Description: Monthly backup for critical data with 10 years retention and copy to central vault
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanCriticalMonthly10y:
              rules:
                OrgCriticalMonthlyBackupRule10y:
                  schedule_expression:
                    "@@assign": !Ref pMonthlyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '1440'
                  lifecycle:
                    delete_after_days:
                      "@@assign": '30'  # Local retention: 30 days
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-years"
                      tag_value:
                        "@@assign": "10"
                    data-criticality:
                      tag_key:
                        "@@assign": "data-criticality"
                      tag_value:
                        "@@assign": "critical"
                  copy_actions:
                    # IMPORTANT: Key name must match the vault ARN exactly
                    # Replace this with your actual central vault ARN
                    arn:aws:backup:us-east-1:129654119448:backup-vault:AWSBackupSolutionCentralVault:
                      target_backup_vault_arn:
                        "@@assign": !Ref pCentralBackupVaultArn
                      lifecycle:
                        move_to_cold_storage_after_days:
                          "@@assign": '90'
                        delete_after_days:
                          "@@assign": '3650'  # 10 years
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgCriticalMonthly10ySelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": !Ref pBackupTagKey
                    tag_value:
                      "@@assign":
                      - "transactions-regulated"
                      - "client-data"
                      - "financial-data"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

  # ========================================
  # POLICY 6: DEFAULT BACKUP (for resources without specific tags)
  # No specific tag value - catches all resources without data-type-bkp tag
  # ========================================
  rOrgBackupPolicyDefault:
    Type: AWS::Organizations::Policy
    Properties:
      Name: org-backup-default-production
      Description: Default backup policy for resources without specific data-type-bkp tags
      Type: BACKUP_POLICY
      TargetIds: !Ref pOrgBackupTargetOUsProduction
      Content:
        Fn::ToJsonString:
          plans:
            OrgBackupPlanDefault:
              rules:
                # Default Daily Rule
                OrgDefaultDailyBackupRule:
                  schedule_expression:
                    "@@assign": !Ref pDailyBackupSchedule
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '600'
                  lifecycle:
                    delete_after_days:
                      "@@assign": '7'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "7"
                # Default Weekly Rule
                OrgDefaultWeeklyBackupRule:
                  schedule_expression:
                    "@@assign": cron(30 2 ? * 7 *)  # Sunday at 02:30 UTC
                  start_backup_window_minutes:
                    "@@assign": '60'
                  complete_backup_window_minutes:
                    "@@assign": '1440'
                  lifecycle:
                    delete_after_days:
                      "@@assign": '30'
                  target_backup_vault_name:
                    "@@assign": !Ref pMemberAccountBackupVault
                  recovery_point_tags:
                    project:
                      tag_key:
                        "@@assign": !Ref pTagKey
                      tag_value:
                        "@@assign": !Ref pTagValue
                    retention:
                      tag_key:
                        "@@assign": "retention-days"
                      tag_value:
                        "@@assign": "30"
              backup_plan_tags:
                project:
                  tag_key:
                    "@@assign": !Ref pTagKey
                  tag_value:
                    "@@assign": !Ref pTagValue
              regions:
                "@@append": !Ref pRegions
              selections:
                tags:
                  OrgDefaultSelection:
                    iam_role_arn:
                      "@@assign": !Sub 'arn:aws:iam::$account:role/${pCrossAccountBackupRole}'
                    tag_key:
                      "@@assign": "backup-enabled"
                    tag_value:
                      "@@assign":
                      - "true"
      Tags:
      - Key: Application
        Value: !Ref Application
      - Key: CommitId
        Value: !Ref CommitId
      - Key: BusinessUnit
        Value: !Ref BusinessUnit
      - Key: CostCenter
        Value: !Ref CostCenter
      - Key: Environment
        Value: !Ref Environment
      - Key: ApplicationOwner
        Value: !Ref ApplicationOwner

Outputs:
  BackupPolicyDaily7dId:
    Description: Organization Policy ID for Daily 7d Backup
    Value: !Ref rOrgBackupPolicyDaily7d
  
  BackupPolicyWeekly30dId:
    Description: Organization Policy ID for Weekly 30d Backup
    Value: !Ref rOrgBackupPolicyWeekly30d
  
  BackupPolicyMonthly90dId:
    Description: Organization Policy ID for Monthly 90d Backup
    Value: !Ref rOrgBackupPolicyMonthly90d
  
  # BackupPolicyMonthly180dId:
  #   Description: Organization Policy ID for Monthly 180d Backup
  #   Value: !Ref rOrgBackupPolicyMonthly180d
  
  BackupPolicyCriticalDailyId:
    Description: Organization Policy ID for Critical Daily Backup
    Value: !Ref rOrgBackupPolicyCriticalDaily
  
  BackupPolicyCriticalMonthly10yId:
    Description: Organization Policy ID for Critical Monthly 10y Backup
    Value: !Ref rOrgBackupPolicyCriticalMonthly10y
  
  BackupPolicyDefaultId:
    Description: Organization Policy ID for Default Backup
    Value: !Ref rOrgBackupPolicyDefault
